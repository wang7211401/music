<!doctype html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="songs.css">
    <link rel="shortcut icon" href="images/favicon.ico">
    <script src="//at.alicdn.com/t/font_393221_hhvp2hpq1dm6xbt9.js"></script>
</head>
<body>
    <div class="container">
        <div class="page"></div>
        <div class="top-wrap">
            <div class="top-disc">
                <div class="top-disc-turn">
                    <img  class="disc-before" src="https://i.loli.net/2017/08/27/59a24681d5aff.png" alt="">
                    <img class="disc-after" src="https://i.loli.net/2017/08/27/59a2475fd6237.png" alt="">
                    <div class="top-img">

                    </div>
                </div>
                <svg class="icon-play">
                    <use xlink:href="#icon-cplay1"></use>
                </svg>
                <svg class="icon-pause">
                    <use xlink:href="#icon-pause"></use>
                </svg>
                <img src="https://i.loli.net/2017/08/27/59a2410ddb21b.png" alt="">
            </div>
        </div>
        <div class="song-content">

            <div class="song-lyric">
                <div class="lines"></div>
            </div>
        </div>
        <div class="footer">
            <a class="footer-open" href="#">打开</a>
            <a class="download" href="#">下载</a>
        </div>
    </div>
    <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="vendors/av-min.js"></script>
    <script>
        var APP_ID = 'i19UWtaghVE36y85Oo4Uscyx-gzGzoHsz';
        var APP_KEY = 'J2ge2uYbUiOX1pOAYBILAGon';
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY
        });
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
        var id = getParameterByName('id');
        var query = new AV.Query('Topsong');
        query.get(id).then(function(results){
            let url= results.attributes.url;
            let images = results.attributes.images;
            let name = results.attributes.name;
            let singer = results.attributes.singer.split('-')[0];
            let lyric =results.attributes.lyric;
            let title = `<title>${name}</title>`;
            $('head').append(title);
            $('.page').css("background-image", `url(${images})`);
            let img = `<img src="${images}" alt="">`;
            $('.top-img').append(img);
            let h3 =`<h3>${name} - <span>${singer}</span></h3>`;
            $('.song-content').prepend(h3);
            ininPlayer(url);
            parseLyric(lyric);
        });
        function parseLyric(lyric){
            let array = lyric.split('\n');
            let regex = /^\[(.+)\](.*)$/;
            array = array.map(function(string, index){
                let matches = string.match(regex);
                if(matches){
                    return {time: matches[1], words: matches[2]}
                }
            });
            let $lyriclines = $('.lines');
            array.map(function(object){
                if(!object){return}
                let $p = $('<p/>');
                $p.attr('data-time', object.time).text(object.words);
                $lyriclines.append($p)
            })
        }
        function ininPlayer(url){
            var audio = document.createElement('audio');
            audio.src= url;
            document.body.appendChild(audio);
            $('.icon-play').on('click',function(){
                audio.play();
                $('.top-disc').addClass('active');
            });
            $('.icon-pause').on('click',function(){
                audio.pause();
                $('.top-disc').removeClass('active');
            });
            audio.onended =function(){
                $('.top-disc').removeClass('active');
            };
            setInterval(function(){
                let seconds = audio.currentTime;
                let munites = ~~(seconds / 60);
                let left = seconds - munites * 60;
                let time = `${pad(munites)}:${pad(left)}`;
                let $lines = $('.lines >p');
                let $whichLine;
                for(let i=0;i<$lines.length;i++){
                    let currentLineTime = $lines.eq(i).attr('data-time');
                    let nextLineTime = $lines.eq(i+1).attr('data-time');
                    if($lines.eq(i+1).length !==0 && currentLineTime < time && nextLineTime > time){
                        $whichLine = $lines.eq(i)
                    }
                }
                if($whichLine){
                    $whichLine.addClass('active').prev().removeClass('active');
                    let top = $whichLine.offset().top;
                    let linesTop = $('.lines').offset().top;
                    let delta = top - linesTop - $('.song-lyric').height()/3;
                    $('.lines').css('transform',`translateY(-${delta}px)`)
                }
            },300);
        }
        function pad(number){
            return number >=10 ? number + '' : '0' + number
        }
    </script>
</body>
</html>